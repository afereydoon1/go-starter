# Use official Go Alpine image
FROM golang:1.25.1-alpine

# Install bash and git
RUN apk add --no-cache bash git

# Set working directory
WORKDIR /app

# Set Go binary path for Air
ENV GOBIN=/usr/local/bin
ENV PATH=$PATH:/usr/local/bin

# Install Air hot-reload tool
RUN go install github.com/air-verse/air@latest

# Copy go.mod and go.sum first
COPY go.mod go.sum ./
RUN go mod download

# Copy rest of the code
COPY . .

# Create non-root user BEFORE chown
RUN adduser -D devuser && \
    mkdir -p /app/tmp && \
    chown -R devuser:devuser /app && \
    chmod -R 755 /app/tmp

# Switch to non-root user
USER devuser

# Start with Air
CMD ["air"]
